<!DOCTYPE html>
<html>
<head>
  <title>GPT Chatbot for Tableau</title>
  <script src="https://tableau.github.io/extensions-api/lib/tableau.extensions.1.latest.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chat-container">
    <h2>Ask GPT</h2>
    <input type="text" id="query-input" placeholder="e.g., What‚Äôs the trend for Sales?" />
    <button id="ask-button">Ask GPT</button>
    <div id="response">Awaiting input...</div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const askBtn = document.getElementById("ask-button");
      const queryInput = document.getElementById("query-input");
      const responseDiv = document.getElementById("response");

      function log(msg) {
        responseDiv.innerText += "\n" + msg;
        console.log(msg);
      }

      log("‚úÖ DOM loaded. Waiting for Tableau...");

      const check = setInterval(() => {
        if (typeof tableau !== "undefined" && tableau.extensions) {
          clearInterval(check);
          log("‚úÖ Tableau API available");

          tableau.extensions.initializeAsync().then(() => {
            log("‚úÖ Extension initialized");

            askBtn.addEventListener("click", async () => {
              const query = queryInput.value.trim();
              if (!query) {
                responseDiv.innerText = "‚ùå Please enter a question.";
                return;
              }

              responseDiv.innerText = "Thinking...";
              log("üì• Query: " + query);

              try {
                const worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
                const summary = await worksheet.getSummaryDataAsync();
                const cols = summary.columns.map(c => c.fieldName);
                const data = summary.data.map(row =>
                  Object.fromEntries(row.map((cell, i) => [cols[i], cell.formattedValue]))
                );

                const prompt = `
You're helping a Tableau user. They asked:

"${query}"

Here is the data from worksheet "${worksheet.name}" (up to 30 rows):

${JSON.stringify(data.slice(0, 30), null, 2)}
                `.trim();

                const res = await fetch("https://gpt-proxy-5hrz.onrender.com/ask", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ query: prompt })
                });

                const result = await res.json();
                responseDiv.innerText = result.response || "‚ùå No response from GPT.";
              } catch (err) {
                log("‚ùå Error: " + err.message);
                responseDiv.innerText = "‚ùå Failed to read worksheet data.";
              }
            });
          }).catch(err => {
            log("‚ùå Failed to initialize extension: " + err.message);
            responseDiv.innerText = "‚ùå Tableau extension initialization failed.";
          });
        }
      }, 100);
    });
  </script>
</body>
</html>
