<!DOCTYPE html>
<html>
<head>
  <title>GPT Chatbot for Tableau</title>
  <script src="https://tableau.github.io/extensions-api/lib/tableau.extensions.1.latest.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chat-container">
    <h2>Ask GPT</h2>
    <input type="text" id="query-input" placeholder="e.g., Sum of Forecast by Year?" />
    <button id="ask-button">Ask GPT</button>
    <div id="response">Awaiting input...</div>
  </div>
  <script>
    function logToUI(msg) {
      const responseDiv = document.getElementById("response");
      if (responseDiv) {
        responseDiv.innerText += "\n" + msg;
      }
      console.log(msg);
    }

    function initGPT() {
      const askBtn = document.getElementById("ask-button");
      const queryInput = document.getElementById("query-input");
      const responseDiv = document.getElementById("response");

      logToUI("âœ… Tableau API detected");

      askBtn.addEventListener("click", async () => {
        const query = queryInput.value.trim();
        if (!query) {
          responseDiv.innerText = "âŒ Please enter a question.";
          return;
        }

        responseDiv.innerText = "Thinking...";
        logToUI("ðŸ“¥ Query: " + query);

        let data = [];
        let cols = [];

        try {
          await tableau.extensions.initializeAsync();
          const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
          const worksheet = worksheets[0];

          logToUI("ðŸ“„ Using worksheet: " + worksheet.name);

          const summary = await worksheet.getSummaryDataAsync();
          cols = summary.columns.map(c => c.fieldName);
          data = summary.data.map(row =>
            Object.fromEntries(row.map((cell, i) => [cols[i], cell.formattedValue]))
          );

          logToUI("ðŸ§© Columns: " + cols.join(", "));
          logToUI("ðŸ“ˆ Rows: " + data.length);
        } catch (err) {
          logToUI("âŒ getSummaryDataAsync() failed: " + err.message);
          responseDiv.innerText = "âŒ Failed to read worksheet data.";
          return;
        }

        const prompt = `
You're helping a Tableau user. They asked:

"\${query}"

Here is the data from the worksheet (sample up to 30 rows):

\${JSON.stringify(data.slice(0, 30), null, 2)}
`.trim();

        try {
          const res = await fetch("https://gpt-proxy-5hrz.onrender.com/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: prompt })
          });

          const result = await res.json();
          responseDiv.innerText = result.response || "âŒ No response.";
          logToUI("ðŸ¤– GPT response complete");
        } catch (err) {
          logToUI("âŒ Fetch error: " + err.message);
          responseDiv.innerText = "âŒ GPT call failed.";
        }
      });
    }

    function waitForTableauAndInit() {
      const check = setInterval(() => {
        if (typeof tableau !== "undefined" && tableau.extensions) {
          clearInterval(check);
          initGPT();
        }
      }, 100);
    }

    document.addEventListener("DOMContentLoaded", () => {
      logToUI("âœ… DOM loaded. Waiting for Tableau...");
      waitForTableauAndInit();
    });
  </script>
</body>
</html>
